<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>PROF-SAFE24 PREMIUM â€“ Painel do Professor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="title">ğŸ‘©â€ğŸ« PROF-SAFE24 PREMIUM</div>
      <div class="subtitle">Painel do Professor</div>
    </div>

    <div class="center">
      <!-- BotÃ£o SOS clicÃ¡vel -->
      <button class="sos-wrap" id="btnSOS" aria-label="Acionar SOS">
        <img src="{{ url_for('static', filename='sos.png') }}" class="sos-btn" alt="SOS">
      </button>
      <div class="hint">Toque apenas em emergÃªncia</div>
    </div>

    <div class="section">
      <div class="section-title">IdentificaÃ§Ã£o e tipo de ocorrÃªncia</div>

      <label class="lbl">Nome do professor(a) (opcional)</label>
      <input class="input" id="professorNome" placeholder="Ex.: Prof. Ana Paula">

      <label class="lbl">Sala / Local</label>
      <input class="input" id="salaLocal" placeholder="Ex.: 7Âº Ano B - Sala 12">

      <div class="chips-title">Problemas rÃ¡pidos (1 clique):</div>
      <div class="chips" id="chips">
        <button class="chip" data-tipo="Aluno passou mal">ğŸ˜· Aluno passou mal</button>
        <button class="chip" data-tipo="Briga na sala/corredor">âš ï¸ Briga na sala/corredor</button>
        <button class="chip" data-tipo="InvasÃ£o/pessoa estranha">ğŸš¨ InvasÃ£o / pessoa estranha</button>
        <button class="chip" data-tipo="AgressÃ£o ao professor">â›” AgressÃ£o ao professor</button>
        <button class="chip" data-tipo="Objeto suspeito/arma">ğŸ—¡ï¸ Objeto suspeito / arma</button>
        <button class="chip" data-tipo="Tentativa de arrombamento">ğŸ”´ Tentativa de arrombamento</button>
        <button class="chip" data-tipo="Risco no portÃ£o">ğŸšª Risco no portÃ£o</button>
        <button class="chip" data-tipo="Suspeito no entorno">ğŸ‘¤ Suspeito no entorno</button>
      </div>

      <label class="lbl">DescriÃ§Ã£o (se quiser)</label>
      <textarea class="textarea" id="descricao" rows="3"
        placeholder="VocÃª pode complementar a descriÃ§Ã£o do que estÃ¡ acontecendo..."></textarea>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnEnviar">ğŸš¨ Enviar alerta</button>
      <button class="btn" id="btnLimpar">ğŸ§¹ Limpar</button>
      <button class="btn danger2" id="btnReiniciar">ğŸ”„ Reiniciar</button>
    </div>

    <button class="btn danger full" onclick="sair()">Sair</button>

    <div id="status" class="status">Pronto para uso.</div>
  </div>
</div>

<script>
  // ===============================
  // Estado
  // ===============================
  let tipoSelecionado = "";

  // ===============================
  // Helpers UI
  // ===============================
  function setStatus(msg, ok=true){
    const el = document.getElementById("status");
    el.textContent = msg;
    el.style.color = ok ? "#22c55e" : "#f97316";
  }

  function limparCampos(){
    document.getElementById("professorNome").value = "";
    document.getElementById("salaLocal").value = "";
    document.getElementById("descricao").value = "";
    tipoSelecionado = "";
    document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
    setStatus("Pronto para uso.", true);
  }

  // ===============================
  // SeleÃ§Ã£o de ocorrÃªncia (chips)
  // ===============================
  document.getElementById("chips").addEventListener("click", (e)=>{
    const btn = e.target.closest(".chip");
    if(!btn) return;

    document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
    btn.classList.add("active");
    tipoSelecionado = btn.dataset.tipo || "";
    setStatus("OcorrÃªncia selecionada: " + tipoSelecionado, true);
  });

  // ===============================
  // Enviar alerta
  // ===============================
  async function enviarAlerta(forcarSOS=false){
    const nome = document.getElementById("professorNome").value.trim();
    const sala = document.getElementById("salaLocal").value.trim();
    const desc = document.getElementById("descricao").value.trim();

    const tipo = forcarSOS ? "SOS (PÃ¢nico)" : (tipoSelecionado || "SOS (PÃ¢nico)");

    if(!sala){
      setStatus("âš ï¸ Informe a Sala/Local.", false);
      document.getElementById("salaLocal").focus();
      return;
    }

    const payload = {
      origem: "professor",
      professor: nome || "Professor(a)",
      sala_local: sala,
      tipo: tipo,
      descricao: desc
    };

    try{
      setStatus("Enviando alerta...", true);
      const resp = await fetch("/api/alert", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if(data && data.ok){
        setStatus("âœ… Alerta enviado com sucesso!", true);
        // volta ao normal em 5s (sem mudar de tela)
        setTimeout(()=>setStatus("Pronto para uso.", true), 5000);
      }else{
        setStatus("âŒ Erro ao enviar alerta.", false);
      }
    }catch(err){
      setStatus("âŒ Erro de rede ao enviar alerta.", false);
    }
  }

  document.getElementById("btnEnviar").addEventListener("click", ()=>enviarAlerta(false));
  document.getElementById("btnSOS").addEventListener("click", ()=>enviarAlerta(true));

  // ===============================
  // Limpar / Reiniciar
  // ===============================
  document.getElementById("btnLimpar").addEventListener("click", limparCampos);

  document.getElementById("btnReiniciar").addEventListener("click", async ()=>{
    if(!confirm("Deseja reiniciar e limpar o sistema?")) return;

    try{
      const resp = await fetch("/api/clear", { method:"POST" });
      const data = await resp.json();
      if(data && data.ok){
        limparCampos();
        setStatus("âœ… Sistema reiniciado. Pronto para uso.", true);
      }else{
        setStatus("âŒ Erro ao reiniciar.", false);
      }
    }catch(e){
      setStatus("âŒ Erro de rede ao reiniciar.", false);
    }
  });

  // ===============================
  // Sair (professor isolado)
  // ===============================
  function sair(){
    window.location.href = "/professor";
  }

  // TRAVA NAVEGAÃ‡ÃƒO: professor nÃ£o sai do prÃ³prio painel
  (function lockProfessor(){
    try{
      history.replaceState(null, "", "/professor");
      history.pushState(null, "", "/professor");
      window.addEventListener("popstate", function(){
        window.location.href="/professor";
      });
    }catch(e){}
  })();
</script>

</body>
</html>
